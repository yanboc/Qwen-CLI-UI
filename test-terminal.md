# 虚拟终端功能测试指南

## 🎯 方案三实现：虚拟终端 + 状态同步

### 核心特性
- ✅ 每个终端都是独立的虚拟终端实例
- ✅ 真实状态保持：缓冲区、历史记录完整保存
- ✅ 单一 DOM 容器：只有活跃终端占用 DOM 资源
- ✅ 无缝切换：切换时完整恢复终端状态

## 🧪 测试步骤

### 1. 测试虚拟终端创建和切换
- [ ] 创建终端 t1
- [ ] 在 t1 中输入：`echo "This is terminal 1"` 并按回车
- [ ] 创建终端 t2
- [ ] 在 t2 中输入：`echo "This is terminal 2"` 并按回车
- [ ] 切换回 t1，检查是否显示 "This is terminal 1"
- [ ] 切换回 t2，检查是否显示 "This is terminal 2"
- [ ] **预期结果**：每个终端保持独立的状态和历史

### 2. 测试输入不重复问题
- [ ] 在任意终端输入单个字符 'l'
- [ ] **预期结果**：只显示一个 'l'，不会重复
- [ ] 输入 'ls' 命令
- [ ] **预期结果**：正常执行，无重复字符

### 3. 测试新建终端界面
- [ ] 点击下拉选择器创建新终端
- [ ] **预期结果**：立即显示命令提示符，可以直接输入命令
- [ ] 检查是否无需额外输入就能看到 shell 提示符

### 4. 测试会话管理
- [ ] 创建多个终端（t1, t2, t3）
- [ ] 点击刷新按钮
- [ ] **预期结果**：会话列表正确更新，当前活跃终端保持
- [ ] 重命名一个终端
- [ ] **预期结果**：名称更新成功
- [ ] 关闭一个终端
- [ ] **预期结果**：终端被移除，自动切换到其他终端

### 5. 测试终端状态持久化
- [ ] 在 t1 中运行：`cd /tmp && pwd`
- [ ] 切换到 t2，运行：`cd /home && pwd`
- [ ] 切换回 t1，运行：`pwd`
- [ ] **预期结果**：t1 显示 `/tmp`，t2 显示 `/home`
- [ ] 在 t1 中运行长命令：`find / -name "*.log" 2>/dev/null | head -10`
- [ ] 立即切换到 t2，等待几秒后切换回 t1
- [ ] **预期结果**：t1 显示命令完整输出，状态完全保持

## 🔧 架构验证

### VirtualTerminal 类功能
- [ ] 检查浏览器控制台，确认虚拟终端创建日志
- [ ] 验证 `activate()` 和 `deactivate()` 调用日志
- [ ] 确认缓冲区数据正确保存和恢复

### TerminalManager 类功能
- [ ] 验证只有一个 TerminalManager 实例
- [ ] 检查 WebSocket 事件监听器只绑定一次
- [ ] 确认会话切换日志正确显示

### 单一 DOM 容器
- [ ] 检查 DOM 结构，确认只有一个终端容器
- [ ] 验证切换时没有创建新的 DOM 元素
- [ ] 确认内存使用稳定，无泄漏

## 📊 性能测试

### 内存使用
- [ ] 创建 5 个终端，检查内存使用情况
- [ ] 切换终端 20 次，观察内存是否稳定
- [ ] 关闭终端，确认内存正确释放

### 切换性能
- [ ] 测试终端切换速度（应该是即时的）
- [ ] 验证大量输出后的切换性能
- [ ] 确认历史记录恢复速度

## 🐛 问题修复验证

### 1. 输入重复问题 ✅
- **原因**：多个组件实例同时监听 WebSocket 事件
- **解决**：使用 TerminalManager 统一管理事件监听
- **验证**：输入字符只显示一次

### 2. 终端切换显示异常 ✅
- **原因**：所有终端组件同时接收数据并写入
- **解决**：虚拟终端模式，只有活跃终端写入 DOM
- **验证**：切换时不会出现内容累积

### 3. 新建终端无界面 ✅
- **原因**：终端创建后未发送初始化命令
- **解决**：VirtualTerminal 连接后自动发送初始命令
- **验证**：新建终端立即显示提示符

### 4. 刷新键失效 ✅
- **原因**：刷新函数逻辑错误
- **解决**：重新实现 refreshSessions 函数
- **验证**：刷新按钮正常工作

## 🎉 预期改进效果

### 用户体验
- 🚀 **即时切换**：终端切换无延迟
- 💾 **完整状态保持**：每个终端保持独立状态
- 🎯 **精确输入**：无重复输入问题
- 🔄 **稳定切换**：无显示异常

### 技术优势
- 📉 **低内存占用**：只有活跃终端占用 DOM
- 🔧 **易于维护**：清晰的架构分离
- 🛡️ **错误隔离**：单个终端问题不影响其他
- ⚡ **高性能**：虚拟化减少资源消耗

## 🚀 测试命令建议

```bash
# 测试目录切换持久化
cd /tmp && echo "In tmp directory" && pwd

# 测试长时间运行命令
ping -c 10 8.8.8.8

# 测试环境变量持久化
export TEST_VAR="terminal_1" && echo $TEST_VAR

# 测试历史记录
history | tail -5

# 测试文件操作
touch test_file_$(date +%s).txt && ls -la test_file_*
```

现在可以启动服务器和前端进行测试了！ 